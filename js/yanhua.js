var digit=[
		[	/*18*/
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
			[0,0,0,0,1,1,1,0,1,1,1,0,0,0,0,0,0,0],
			[0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,0,0,0],
			[0,0,0,1,1,1,0,1,1,1,1,1,1,1,1,1,0,0],
			[0,0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0],
			[0,0,1,1,1,0,1,1,1,0,0,0,0,1,1,1,0,0],
			[0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0],
			[0,1,1,1,1,1,1,1,0,1,1,1,0,0,0,0,0,0],
			[0,0,0,1,1,0,0,1,1,1,1,1,1,1,0,0,0,0],
			[0,0,0,1,1,0,0,1,1,1,1,1,1,1,1,0,0,0],
			[0,0,0,1,1,0,1,1,1,1,1,1,0,1,1,1,0,0],
			[0,0,0,1,1,1,1,1,0,1,1,1,0,1,1,1,0,0],
			[0,0,0,1,1,1,1,1,0,1,1,1,0,0,1,1,1,0],
			[0,0,0,1,1,0,0,0,0,1,1,1,0,0,0,0,0,0],
			[0,0,0,1,1,0,0,0,1,1,1,1,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
		],
		[
		 [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		 [0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0],
		 [0,0,0,1,1,1,0,0,1,1,1,1,1,1,1,1,0,0],
		 [0,0,0,1,1,1,0,0,1,1,1,1,1,1,1,1,0,0],
		 [0,0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,0],
		 [0,1,1,1,1,1,1,1,1,0,0,1,1,1,0,0,0,0],
		 [0,0,1,1,1,0,1,1,0,0,0,1,1,0,0,0,0,0],
		 [0,0,1,1,1,1,1,1,0,0,0,1,1,0,0,0,0,0],
		 [0,0,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0],
		 [0,1,1,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0],
		 [0,0,0,1,1,1,1,0,0,0,0,1,1,0,0,0,0,0],
		 [0,0,0,0,1,1,1,0,0,0,0,1,1,0,0,0,0,0],
		 [0,0,0,1,1,1,1,1,0,0,0,1,1,0,0,0,0,0],
		 [0,0,1,1,1,0,1,1,1,0,1,1,1,0,0,0,0,0],
		 [0,1,1,1,0,0,0,0,0,1,1,1,1,0,0,0,0,0],
		 [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
		],
		[
		 [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		 [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
		 [0,1,1,1,0,1,1,0,0,0,0,0,1,1,1,0,0],
		 [0,1,1,1,0,1,1,1,1,1,0,0,1,1,1,0,0],
		 [0,1,1,1,0,1,1,1,1,1,0,0,1,1,1,0,0],
		 [0,1,1,1,0,1,1,1,1,1,0,0,1,1,0,0,0],
		 [0,1,1,1,0,1,1,1,1,1,0,0,1,1,0,0,0],
		 [0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0],
		 [0,1,1,1,0,1,1,0,0,0,0,0,0,0,1,1,0],
		 [0,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,0],
		 [0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0],
		 [0,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,0],
		 [0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0],
		 [0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0],
		 [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
		],
		[//17
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0],
			[0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
			[0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0],
			[0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0],
			[0,0,1,1,1,0,0,0,1,1,1,1,1,1,1,1,0],
			[0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0],
			[0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0],
			[0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
			[0,0,1,1,1,1,1,0,0,0,0,0,1,1,1,0,0],
			[0,0,1,1,1,1,1,0,0,0,0,0,1,1,1,0,0],
			[0,0,1,1,1,1,1,0,0,0,0,0,1,1,1,0,0],
			[0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0],
			[0,1,1,1,0,1,1,0,0,0,0,0,1,1,1,0,0],
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
		],
		[
		 	[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
			[0,0,0,0,1,1,1,0,0,0,0,1,1,0,0,0,0],
			[0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,0,0],
			[0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0,0],
			[0,0,0,0,1,1,1,0,1,1,1,0,0,0,0,0,0],
			[0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0],
			[0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],
			[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
			[0,0,0,0,1,1,1,0,1,1,1,0,0,0,0,0,0],
			[0,0,0,0,1,1,1,0,1,1,1,0,0,0,0,0,0],
			[0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0,0],
			[0,0,0,0,1,1,1,0,1,1,1,1,1,0,0,0,0],
			[0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
			[0,0,0,0,1,1,1,1,1,0,0,1,1,1,1,1,0],
			[0,0,0,0,1,1,1,0,0,0,0,0,0,1,1,1,0],
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]		
		]	
	   ];






var _begin=false;




//当用canvas做动画时最好用requestAnimationFrame代替setTimeout或Interval不支持的浏览器用setTimeout
window.requestAnimFrame = ( function() {
	return window.requestAnimationFrame ||
				window.webkitRequestAnimationFrame ||
				window.mozRequestAnimationFrame ||
				function( callback ) {
					window.setTimeout( callback, 1000 / 60 );
				};
})();

//进行画布的基础参数设置
var canvas = document.getElementById( 'canvas' ),
		ctx = canvas.getContext( '2d' ),
		//全屏画布
		cw = window.innerWidth,
		ch = window.innerHeight,
		//烟花射线集合容器
		fireworks = [],
		// 烟花散开粒子集合容器
		particles = [],
		// 开始的色相
		hue = 120,
		//没5帧发射的烟花到顶部并散开
		limiterTotal = 5,
		limiterTick = 0,
		// 没80帧触发一次烟花效果
		timerTotal = 80,
		timerTick = 0,
		mousedown = false,
		// 鼠标x坐标,
		mx,
		// 鼠标y坐标
		my;
		
// 设置canvas宽高
canvas.width = cw;
canvas.height = ch;

//创建各种工具函数

//获取最大值最少值随机数
function random( min, max ) {
	return Math.random() * ( max - min ) + min;
}

// 计算每两点之间直线距离
function calculateDistance( p1x, p1y, p2x, p2y ) {
	var xDistance = p1x - p2x,
			yDistance = p1y - p2y;
	return Math.sqrt( Math.pow( xDistance, 2 ) + Math.pow( yDistance, 2 ) );
}

// 创建烟花对象
function Firework( sx, sy, tx, ty ) {
	// 实际坐标
	this.x = sx;
	this.y = sy;
	// 起始坐标
	this.sx = sx;
	this.sy = sy;
	// 目标坐标
	this.tx = tx;
	this.ty = ty;
	// 计算起始达到结束距离
	this.distanceToTarget = calculateDistance( sx, sy, tx, ty );
	this.distanceTraveled = 0;
	// 设置坐标集合
	this.coordinates = [];
	this.coordinateCount = 3;
	// 初始化坐标集合并更新现在的坐标
	while( this.coordinateCount-- ) {
		this.coordinates.push( [ this.x, this.y ] );
	}
	//计算坐标角度
	this.angle = Math.atan2( ty - sy, tx - sx );
	this.speed = 2;
	this.acceleration = 1.05;//加速度
	this.brightness = random( 50, 70 );//明亮度
	// 园点的半径
	this.targetRadius = 1;
}

// 更新函数
Firework.prototype.update = function( index ) {
	// 移除第一个坐标集合的子集
	this.coordinates.pop();
	// 添加当前坐标位置在集合中
	this.coordinates.unshift( [ this.x, this.y ] );
	
	// 圆形变大变小
	if( this.targetRadius < 8 ) {
		this.targetRadius += 0.3;
	} else {
		this.targetRadius = 1;
	}
	
	// 速度提升函数
	this.speed *= this.acceleration;
	
	// 计算个坐标的速度
	var vx = Math.cos( this.angle ) * this.speed,
			vy = Math.sin( this.angle ) * this.speed;
	// 计算当前速度与加速度下一个点之间的距离
	this.distanceTraveled = calculateDistance( this.sx, this.sy, this.x + vx, this.y + vy );
	
	// 如果长度达到目标距离
	if( this.distanceTraveled >= this.distanceToTarget ) {
		// 创建30个粒子并散开
		createParticles( this.tx, this.ty );
		// 移除当前烟花对象
		fireworks.splice( index, 1 );
	} else {
		// 没到达的话当前坐标加上速度
		this.x += vx;
		this.y += vy;
	}
}

// 烟花画写方法
Firework.prototype.draw = function() {
	ctx.beginPath();
	// 移到上一个坐标点作起点再画出当前坐标
	ctx.moveTo( this.coordinates[ this.coordinates.length - 1][ 0 ], this.coordinates[ this.coordinates.length - 1][ 1 ] );
	ctx.lineTo( this.x, this.y );
	ctx.strokeStyle = 'hsl(' + hue + ', 100%, ' + this.brightness + '%)';
	ctx.stroke();
	
	ctx.beginPath();
	// 画出目标点的小圆圈
	ctx.arc( this.tx, this.ty, this.targetRadius, 0, Math.PI * 2 );
	ctx.stroke();
}

// 创建粒子对象
function Particle( x, y ) {
	this.x = x;
	this.y = y;
	this.coordinates = [];
	this.coordinateCount = 5;
	while( this.coordinateCount-- ) {
		this.coordinates.push( [ this.x, this.y ] );
	}
	// 设置随机角度圈方位
	this.angle = random( 0, Math.PI * 2 );
	this.speed = random( 1, 10 );
	// 摩擦力
	this.friction = 0.95;
	// 重力
	this.gravity = 1;
	// 色相方向
	this.hue = random( hue - 20, hue + 20 );
	this.brightness = random( 50, 80 );
	this.alpha = 1;
	// 设置粒子散开后多久消失
	this.decay = random( 0.015, 0.03 );
}


Particle.prototype.update = function( index ) {
	// 移除第一个坐标
	this.coordinates.pop();

	this.coordinates.unshift( [ this.x, this.y ] );
	// 减慢粒子运动
	this.speed *= this.friction;
	// 计算速度
	this.x += Math.cos( this.angle ) * this.speed;
	this.y += Math.sin( this.angle ) * this.speed + this.gravity;
	// 粒子逐渐消失
	this.alpha -= this.decay;
	
	// 当粒子消失后移除当前集合中的子集
	if( this.alpha <= this.decay ) {
		particles.splice( index, 1 );
	}
}


Particle.prototype.draw = function() {
	ctx. beginPath();
	// 移到上一个坐标点作起点再画出当前坐标
	ctx.moveTo( this.coordinates[ this.coordinates.length - 1 ][ 0 ], this.coordinates[ this.coordinates.length - 1 ][ 1 ] );
	ctx.lineTo( this.x, this.y );
	ctx.strokeStyle = 'hsla(' + this.hue + ', 100%, ' + this.brightness + '%, ' + this.alpha + ')';
	ctx.stroke();
}

// 创建粒子
function createParticles( x, y ) {
	//增加粒子数量会新出大爆炸效果根据canvas性能
	var particleCount = 30;
	while( particleCount-- ) {
		particles.push( new Particle( x, y ) );
	}
}

// 开场循环
function loop() {

	firstStep=requestAnimFrame( loop );
	
	// 色相增加
	hue += 0.5;
	//普遍用clearRect清除画布
	//做运动轨迹用destination-out能把之前的特别地方盖住根据适合
	ctx.globalCompositeOperation = 'destination-out';
	// decrease the alpha property to create more prominent trails
	ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
	ctx.fillRect( 0, 0, cw, ch );
	// lighter进行也是混合，搭配出来烟花特效
	ctx.globalCompositeOperation = 'lighter';
	
	// 不停画出烟花
	var i = fireworks.length;
	while( i-- ) {
		fireworks[ i ].draw();
		fireworks[ i ].update( i );
	}
	
	// 当粒子生成时画出
	var i = particles.length;
	while( i-- ) {
		particles[ i ].draw();
		particles[ i ].update( i );
	}
	
	// 80帧后烟花结束后
	if( timerTick >= timerTotal ) {
		if( !mousedown ) {
			// 随机生成烟花
			fireworks.push( new Firework( cw / 2, ch, random( 0, cw ), random( 0, ch / 2 ) ) );
			timerTick = 0;
			timerTotal-=2;
			if(timerTotal<-1000){
				timerTotal=0;
					 window.cancelAnimationFrame(firstStep);
					 timerTotal=80;
					 console.log(timerTick,timerTotal);
					 var rqaf=window.requestAnimationFrame( once );	
			}
		}
	} else {
		timerTick++;
	}
	// 当鼠标点击时生成烟花
	if( limiterTick >= limiterTotal ) {
		if( mousedown ) {
			fireworks.push( new Firework( cw / 2, ch, mx, my ) );
			limiterTick = 0;
		}
	} else {
		limiterTick++;
	}
}

// 鼠标事件
canvas.addEventListener( 'mousemove', function( e ) {
	mx = e.pageX - canvas.offsetLeft;
	my = e.pageY - canvas.offsetTop;
});

canvas.addEventListener( 'mousedown', function( e ) {
	e.preventDefault();
	mousedown = true;
});

canvas.addEventListener( 'mouseup', function( e ) {
	e.preventDefault();
	mousedown = false;
});




/*********************************

//
//                       _oo0oo_
//                      o8888888o
//                      88" . "88
//                      (| -_- |)
//                      0\  =  /0
//                    ___/`---'\___
//                  .' \\|     |// '.
//                 / \\|||  :  |||// \
//                / _||||| -:- |||||- \
//               |   | \\\  -  /// |   |
//               | \_|  ''\---/''  |_/ |
//               \  .-\__  '-'  ___/-. /
//             ___'. .'  /--.--\  `. .'___
//          ."" '<  `.___\_<|>_/___.' >' "".
//         | | :  `- \`.;`\ _ /`;.`/ - ` : | |
//         \  \ `_.   \_ __\ /__ _/   .-` /  /
//     =====`-.____`.___ \_____/___.-`___.-'=====
//                       `=---='
//
//
//     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
//
//               佛祖保佑         永无BUG
//
//
//



*********************************/
var arr=[];
var _radius=(cw/115)-1>0?(cw/115)-1:1;
function renderDigit(x,y,num){
        for(var i=0;i<digit[num].length;i++){
            for(var j=0;j<digit[num][i].length;j++){
                if(digit[num][i][j]==1){
                    var obj={};
                    obj.x=x+j*(_radius+1)*2+(_radius+1);
                    obj.y=y+i*(_radius+1)*2+(_radius+1);
                    arr.push(obj);
                }
            }
        }
}  


// once the window loads, we are ready for some fireworks!



var index=0;
var radius=1;
var key=0.3;
margin_left=30;
// renderDigit(margin_left,100,0);
// renderDigit(margin_left+37*(_radius+1),100,1);
// renderDigit(margin_left+37*(_radius+1)*2,100+(_radius+1)*2,2);
renderDigit(margin_left,100,3);
renderDigit(margin_left+35*(_radius+1),100,4);
renderDigit(margin_left+35*(_radius+1)*2,100,1);
fireworks.push( new Firework( cw / 2, ch, arr[0].x, arr[0].y ) );
function once(){
	//颜色渐变
	rqaf=window.requestAnimationFrame( once );	
	hue += 0.5;
	if(index==arr.length-1){
		timerTick=0;
		setTimeout(function(){
			window.cancelAnimationFrame(rqaf);
			wordDraw();
			function wordDraw(){
				requestAnimFrame(wordDraw);
				timerTick++;
		
				if(timerTick%500==0){
					hue += 0.5;
					if(_radius>=8||_radius<=1){
						key*=-1;
					}
					_radius+=key;
					var brightness=random( 60, 80 ),alpha=random();
					alpha=alpha>0.6?alpha:0.6;
					ctx.globalCompositeOperation = 'destination-out';
					ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
					ctx.fillRect( 0, 0, cw, ch );				
					ctx.globalCompositeOperation = 'lighter';
					// ctx.strokeStyle = 'hsl(' + hue + ', 100%, ' + brightness + '%)';
					ctx.strokeStyle = 'hsla(' + hue + ', 100%, ' + brightness + '%, ' + alpha + ')';
						for(var i=0;i<=index;i++){
							ctx.beginPath();
							ctx.arc(arr[i].x,arr[i].y, _radius, 0, Math.PI * 2 )
							ctx.closePath();
							ctx.stroke();
						}
			   }
			}
		},2000);
	}
	ctx.globalCompositeOperation = 'destination-out';
	ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
	ctx.fillRect( 0, 0, cw, ch );	
	ctx.globalCompositeOperation = 'lighter';
	//遍历烟花集合里的所有子集

	for(var i=0;i<=index;i++){
		ctx.beginPath();
		ctx.arc(arr[i].x,arr[i].y, 6, 0, Math.PI * 2 )
		ctx.closePath();
		ctx.stroke();
	}
	var i = fireworks.length;
	while( i-- ) {
		fireworks[ i ].draw();
		fireworks[ i ].update( i );
	}	
	var i = particles.length;
	while( i-- ) {
		particles[ i ].draw();
		particles[ i ].update( i );
	}
	if(timerTick>=timerTotal){
		index++;
		fireworks.push( new Firework( cw / 2, ch, arr[index].x, arr[index].y ) );
		timerTick=0;
		timerTotal-=2;
		if(timerTotal<4){
			timerTotal=4;
		}
	}
	else{
		timerTick++;
	}
}